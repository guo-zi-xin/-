# NextTick

NextTick 是一个用于在下次 DOM 更新循环结束之后执行回调函数的方法。其内部原理涉及到 `Vue.js` 的异步更新队列以及浏览器的事件循环机制。

### 异步任务队列

 浏览器中，每个宏任务结束后都会检查微任务队列， 如果有任务则依次执行，当所有微任务执行完成后，才会执行下一个宏任务。 因此可以通过将任务作为微任务添加到微任务队列中，来确保任务在所有宏任务执行完毕后立即执行

 ::: info Javascript的事件运行机制

- **进程与线程**
  - 进程(`process`): 资源分配最小单位， 进程是应用的执行实例，是操作系统进行资源分配和调度的一个独立单位， 如果把计算机CPU必做一个工厂的话， 那么进程就相当于工厂中的车间， 代表CPU所能处理的单个任务
  - 线程(`thread`): 线程是进程内部的一个执行单元，是被系统独立调度和分派的基本单位， 系统创建好进程后， 实际上就启动执行了该进程的主执行线程， 线程则相当于车间里的工人， 一个车间会有多个工人在工作， 所以一个进程可以包含多个线程
  - **浏览器是多线程的， 所以它可以一次能够处理多个事件，比如渲染页面，脚本执行，事件处理等等**
  - **JS则是单线程的， 浏览器只给JS分配了一个线程**

- **执行栈与任务队列**
  - 执行栈：执行栈使用到的是数据结构中的栈结构，它是一个存储函数调用的栈结构， 遵循**先进后出**的原则， 它主要负责跟踪所有要执行的代码。每当一个函数执行完成时， 就会从堆栈中探出(pop)这个执行完成的函数， 如果有代码需要进去执行的话， 就进行push操作
  - 任务队列：任务队列使用到的是数据结构中的队列结构， 它用来保存异步任务，遵循 **先进先出**原则， 它主要负责将新的任务发送到队列中进行处理
  
  执行顺序： 先执行同步任务， 执行完接着执行微任务， 最后执行宏任务。 这个过程会不断重复

![任务执行顺序](../../public/image/任务执行顺序.png)

- **事件循环机制**

![事件循环机制](../../public/image/事件循环机制.png)

 **宏任务(`microtask`)**与**微任务(`macrotask`)**是指在事件循环中两种不同类型的任务

- **宏任务**
  - `script`全局代码
  - `setTimeout` 一次性定时器
  - `setInterval` 持续性定时器
  - `setImmediate`I/O
  - `UI-rendering`的交互事件

- **微任务**
  - `Promise.then(回调)`
  - `MutaionObserver`
  - `process.nextTick()`
  - `async await`
 :::

vue2中， 如果没有特定的执行环境，则会优先使用Promise.then/MutationObserver 否则使用setTimeout
